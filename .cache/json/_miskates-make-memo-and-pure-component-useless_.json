{"data":{"markdownRemark":{"html":"<p>Mến chào các bạn đã quay trở lại với <strong>Kỹ sư mặt tiền</strong>.</p>\n<p>Như đã nhắc đến ở bài trước, khi giới thiệu về <a href='https://kysumattien.com/react-purre-component-and-react-memo/' target='_blank' rel='noopener noreferrer'>PureComponent và memo trong React để tối ưu hóa performance</a>, có các lỗi sai khá phổ biến khiến việc sử dụng <strong>memo</strong> hay <strong>PureComponent</strong> không còn hiệu quả.</p>\n<p>Bật mí luôn cho các bạn rằng các lỗi này sẽ xoay quanh đến việc <strong>so sánh nông</strong> (mình cũng đã có đề cập đến trong bài viết trên).</p>\n<p>Ok, nếu tới đây bạn vẫn chưa biết tại sao, thì cùng mình tìm hiểu các lỗi dưới đây nào.</p>\n<h2>1. Dùng Anonymous function (hàm ẩn danh).</h2>\n<p>Đặc điểm của các hàm ẩn danh này là viết trực tiếp, không cần khai báo một biến cụ thể nắm giữ khai báo hàm (const/var/let).</p>\n<p>Và cụ thể thì dev chúng ta thường hay sử dụng các hàm mũi tiên như là hàm ẩn danh, truyền trực tiếp vào các <strong>event handlers</strong> hay <strong>callback</strong> như <span class='inline-code'>onClick</span>, <span class='inline-code'>onSubmit</span>, … Vì nó nhanh chóng, tiện lợi, khỏi phải mắc công lăn lăn chuột lên trên tìm chỗ để khai báo hàm mới đúng không nào.</p>\n<p><span class='problem-label'>Ví dụ:</span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Button</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>PureComponent</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'re-render Button'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>onBtnClick<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>beautiful-button<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ParentComponent</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    counter<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Số lần click: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>counter<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Button</span></span>\n  <span class=\"token attr-name\">onBtnClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prevState</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> counter<span class=\"token operator\">:</span> prevState<span class=\"token punctuation\">.</span>counter <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          Button đẹp\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Button</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Tại ví dụ này, Component cha <strong>ParentComponent</strong> đang render component con là <strong>Button</strong>. Vốn dĩ sau khi nắm được vấn đề performance về re-render cà cách khắc phục, mình đã cẩn thận dùng <span class='inline-code'>PureComponent</span> thay thì <span class='inline-code'>Component</span> khi khởi tạo component <strong>Button</strong>.</p>\n<p><strong>Button</strong> chỉ nhận vào một prop là một function, có tên là <span class='inline-code'>onBtnClick</span>. Component này không hề cần sử dụng biến state <span class='inline-code'>counter</span> từ component cha, và cũng không có nhu cầu re-render mỗi khi biến state này tăng lên. Đó là lý do mình dùng <span class='inline-code'>PureComponent</span>.</p>\n<p>Nhưng vì callback function pass vào <span class='inline-code'>onBtnClick</span> đang được viết dưới dạng <strong>Anonymous function</strong>, nên vô tình mỗi lần bấm nút tăng biến đếm <span class='inline-code'>counter</span> -> component cha <strong>ParentComponent</strong> re-render -> hàm <span class='inline-code'>render()</span> chạy -> callback anonymous function kia được tạo mới.</p>\n<p>Trong JS, function cũng là object, object được tạo mới thì khi PureComponent thực hiện cơ chế so sánh nông trên prop cũ và mới <span class='inline-code'>onBtnClick</span> sẽ cho là đã có sự thay đổi (again, nếu bạn vẫn chưa nắm cơ chế so sánh nông thì xem lại <a href=\"https://kysumattien.com/react-purre-component-and-react-memo/\" target=\"_blank\">bài này</a> nhé).</p>\n<p>PureComponent thấy rằng prop truyền vào đã change và <strong>tưởng nhầm</strong> rằng bạn muốn update component <strong>Button</strong>, dẫn đến một loạt console.log() hiện ra - thể hiện quá trình re-render diễn ra bên trong <strong>Button</strong>.</p>\n<div class='image-description-wrapper'>\n  <div class='image-wrapper'>\n    <img src='https://i.imgur.com/6YY04mi.png' alt='Button bị re-render mặc dù đã sử dụng PureComponent' />\n  </div>\n  <p class='image-description'>Button bị re-render mặc dù đã sử dụng PureComponent</p>\n</div>\n<p><span class='solution-label'>Giải pháp:</span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ParentComponent</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    counter<span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function-variable function\">btnClickHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prevState</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> counter<span class=\"token operator\">:</span> prevState<span class=\"token punctuation\">.</span>counter <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Số lần click: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>counter<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Button</span></span>\n  <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>btnClickHandler<span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          Button đẹp\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Button</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Tạo một <strong>method</strong> có tên <span class='inline-code'>btnClickHandler</span> nắm giữ callback cần truyền vào <strong>Button</strong>.</p>\n<p>Ứng với cách viết class thì các method chỉ được khởi tạo một lần -> ở mỗi lần component cha re-render, callback function sẽ là duy nhất\n-> PureComponent trong <strong>Button</strong> so sánh thấy object prop cũ và mới là giống nhau -> không re-render.</p>\n<div class='image-description-wrapper'>\n  <div class='image-wrapper'>\n    <img src='https://i.imgur.com/hz5fQ30.png' alt='Giờ thì dù cho click 5 lần, Button vẫn chỉ render 1 lần' />\n  </div>\n  <p class='image-description'>Giờ thì dù cho click 5 lần, Button vẫn chỉ render 1 lần</p>\n</div>\n<h2>2. Lại là Object</h2>\n<p>Tương tự như ví dụ về <strong>Anonymous function</strong> trên. Object literals (Ví dụ: {name: 'a', age: 25}), hay nói chung mọi thứ trong JS mà là object (Object, Aray, Function) khi được khai báo trực tiếp trong hàm render, thì cũng đồng nghĩa với việc object đó sẽ được tạo mới ứng với mỗi lần re-render. Một lần nữa, làm cho việc sử dụng <span class='inline-code'>memo</span> hay <span class='inline-code'>PureComponent</span> trở nên vô tác dụng.</p>\n<p><span class='problem-label'>Ví dụ:</span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ComponentA</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        CHA NÈ CON\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ComponentB</span></span> <span class=\"token attr-name\">myStyle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n  color<span class=\"token operator\">:</span> <span class=\"token string\">'blue'</span><span class=\"token punctuation\">,</span>\n  background<span class=\"token operator\">:</span> <span class=\"token string\">'gold'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ComponentB</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>PureComponent</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        CON NÈ CHA\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Ở dòng code thứ 6, mình đã vô tình truyền một <strong>object literal</strong> vào prop <strong>style</strong>, pass vào component con (<strong>ComponentB</strong>).</p>\n<p>Mỗi lần <strong>ComponentA</strong> re-render, một object được tạo mới trong vùng nhớ Heap. PureComponent trong <strong>ComponentB</strong> dùng cơ chế so sánh nông nhận thấy đây là object mới -> re-render <strong>ComponentB</strong>.</p>\n<p><span class='solution-label'>Giải pháp:</span></p>\n<p>Dùng một biến nắm giữ object này. Thay vì liên tục tạo mới ở mỗi lần re-render, mình sử dụng một class field <span class='inline-code'>myStyle</span> (class fields chỉ được khởi tạo một lần lúc khởi tạo class component đó mà thôi).</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ComponentA</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>myStyle <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      color<span class=\"token operator\">:</span> <span class=\"token string\">'blue'</span><span class=\"token punctuation\">,</span>\n      background<span class=\"token operator\">:</span> <span class=\"token string\">'gold'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        CHA NÈ CON\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ComponentB</span></span> <span class=\"token attr-name\">myStyle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ComponentB</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>PureComponent</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        CON NÈ CHA\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>3. Không move các stable data, function, config, objects ra khỏi render body khi dùng functional component</h2>\n<p>Có thể bạn đã để ý các ví dụ trên mình đang cố gắng dùng toàn là <strong>Class Component</strong> :D. Vì mình muốn tách riêng <strong>Functional Component</strong> cho mục này đấy.</p>\n<p>Với constructor hay quá trình khởi tạo một class, chắc bạn đã biết rằng các cycle này chỉ chạy một lần.</p>\n<p>Hàm constructor của một class chỉ chạy một lần, các method hay properties (thứ được viết bên ngoài hàm <span class='inline-code'>render()</span>) của một class cũng sẽ chỉ được khởi tạo một lần.</p>\n<p>Lợi dụng điều này chúng ta sẽ đạt được mục đích tạo các biến nắm giữ các object, các biến này không bị khởi tạo lại xuyên suốt quá trình re-render nên có thể an toàn pass xuống component con, kết hợp thêm với memo hoặc PureComponent là khỏi lo bị re-render.</p>\n<p>Khác với <strong>Class Component</strong>, các <strong>Functional Component</strong> không có các life cycle như constructor.</p>\n<p>Mọi thứ nằm bên trong \"ruột\" của một <strong>Functional component</strong> chính là <strong>body</strong> của hàm render ứng với người anh em <strong>Class component</strong>.</p>\n<p>Vì thế, ứng với ví dụ trên, mà viết lại bằng functional component, thì:</p>\n<p><span class='problem-label'>Ví dụ:</span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ComponentA</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> myStyle <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    color<span class=\"token operator\">:</span> <span class=\"token string\">'blue'</span><span class=\"token punctuation\">,</span>\n    background<span class=\"token operator\">:</span> <span class=\"token string\">'gold'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      CHA NÈ CON\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ComponentB</span></span> <span class=\"token attr-name\">myStyle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ComponentB <span class=\"token operator\">=</span> <span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      CON NÈ CHA\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Thì dù có cẩn thận khai báo một biến object <span class='inline-code'>myStyle</span> ở <strong>ComponentA</strong> (dòng thứ 2), thì xin \"chúc mừng\"... memo lại không ngăn được việc re-render ở <strong>ComponentB</strong>.</p>\n<p>Bởi vì mỗi với mỗi lần re-render ở ComponentA, mọi thứ nằm bên trong khai báo hàm cũng tương tự như mọi thứ nằm trong ruột của hàm <span class='inline-code'>render()</span> -> object <span class='inline-code'>myStyle</span> vẫn được tạo mới như thường.</p>\n<p>Để giải quyết vấn đề này, ta sẽ move dòng khai báo object <span class='inline-code'>myStyle</span> ra khỏi hẳn scope của functional ComponentA.</p>\n<p><span class='solution-label'>Giải pháp:</span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> myStyle <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  color<span class=\"token operator\">:</span> <span class=\"token string\">'blue'</span><span class=\"token punctuation\">,</span>\n  background<span class=\"token operator\">:</span> <span class=\"token string\">'gold'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ComponentA</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      CHA NÈ CON\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ComponentB</span></span> <span class=\"token attr-name\">myStyle</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ComponentB <span class=\"token operator\">=</span> <span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>myStyle<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      CON NÈ CHA\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Theo cá nhân mình đây là một practice bạn nên dùng nhiều. Áp dụng với các object config, array, hoặc các hàm, logic tính toán chỉ cần khởi tạo một lần và không thay đổi.</p>\n<p>Tuy nhiên, cách viết trên vô tình đem các logic hay các biến ra khỏi phạm vi component, về mặt tính đóng gói thì không hay lắm. Để giải quyết vấn đề này, phương án tối ưu thường được sử dụng hiện nay là dùng React hook <span class='inline-code'>useMemo</span> và <span class='inline-code'>useCallback</span>.</p>\n<p>Trong tương lai, khi đến <a href=\"https://www.kysumattien.com/the-ultimate-guide-about-useMemo-and-useCallback\" rel=\"noopener noreferrer\" target=\"_blank\">post về hai hook này</a>, mình sẽ giải thích cách dùng nha.</p>\n<h2>4. Bonus: biết đến và cẩn thận hơn với mapStateToProps với connect HOC khi dùng react-redux</h2>\n<p>Có thể bạn chưa/đã biết rằng react-redux mặc định đã implement PureComponent để ngăn re-render cho các component con mà nó nhận vào.</p>\n<p>Và nếu bạn vẫn có thói quen sử dụng thao tác, chế biến, khởi tạo và trả về các object, array ngay bên trong <span class='inline-code'>mapStateToProps</span></p>\n<p><span class='problem-label'>Ví dụ:</span></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token function-variable function\">mapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  currentUser<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>currentUserId<span class=\"token punctuation\">,</span> role<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>currentRole\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Thì cũng tương tự như vấn đề gặp phải ở các section trên. Object luôn được tạo mới, và PureComponent sẽ không ngăn được việc re-render.</p>\n<p>Tiếp nữa, khi làm việc với redux, thường object <strong>store</strong> tổng sẽ là kết hợp của rất nhiều <strong>sub-states</strong> (dùng <span class='inline-code'>combineReducer</span>).</p>\n<p>Và nếu bạn chưa biết, thì <strong>mapStateToProps</strong> sẽ chạy khi bất cứ thành phần nào của store tổng bị thay đổi, không cần biết thành phần thay đổi đó có liên quan gì đến component này hay không.</p>\n<p>Ngoài việc tạo mới object như mình mới đề cập ở trên, thì việc đặt các <strong>logic tính toán nặng</strong> bên trong mapStateToProps cũng sẽ gây ảnh hưởng đến performance của app. (Vì nó chạy rất thường xuyên)</p>\n<blockquote>\n<p>Whenever the store changes, all of the mapStateToProps functions of all of the connected components will run. Because of this, your mapStateToProps functions should run as fast as possible. This also means that a slow mapStateToProps function can be a potential bottleneck for your application. - Trích \"react-redux\" documentation</p>\n</blockquote>\n<blockquote>\n<p>Bất cứ khi nào store thay đổi, <strong>tất cả</strong> các hàm mapStateToProps dùng trong các component sẽ được chạy. Vì vậy, tốt hơn hết là các hàm mapStateToProps kia nên chạy nhanh nhất có thể. Nếu không, nó sẽ làm app của bạn bị chậm, thuật ngữ là nghẽn cổ chai - tui dịch</p>\n</blockquote>\n<p>Để tránh các tình trạng trên thì bạn nên tập thói quen không tạo object mới, không đặt các logic tính toán nặng trong các hàm mapStateToProps, và sau cùng là nên sử dụng một library cung cấp các cơ chế memoization để tối ưu hóa performance, điển hình như là <strong>reselect</strong>.</p>\n<p>Ngay trong document của react-redux cũng có đề cập đến:</p>\n<blockquote>\n<p>We highly encourage the use of \"selector\" functions to help encapsulate the process of extracting values from specific locations in the state tree. Memoized selector functions also play a key role in improving application performance (see the following sections in this page and the Advanced Usage: Computing Derived Data page for more details on why and how to use selectors.) - Trích \"react-redux\" documentation</p>\n</blockquote>\n<h2>5. Kết luận</h2>\n<p>Như vậy là mình đã cùng các bạn điểm qua các lỗi sai khiến cho việc sử dụng memo hay PureComponent không còn hiệu quả, và khiến app không cải thiện performance rồi.</p>\n<p>Nhìn chung các lỗi này xoay quanh đến chủ đề object và cơ chế so sánh nông.</p>\n<p>Một khi đã biết đến các vấn đề này rồi thì việc tránh và dùng đúng cách các kỹ thuật khi code cũng không quá khó đúng không các bạn.</p>\n<p>Hẹn gặp các bạn trong các bài viết lần sau. Mến chào các bạn!</p>","featuredImg":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACF0lEQVQ4y2NgnbKFbMRAE81sYARhsE7eTIrmqVuYJm5inryZbdpWxkmbmaduJVYz0CqGyZs1p2/VLZnL0LveeNJm3taVzDO2Y9qPQ/OMnerd202COxhqFxVvP+czcTtD51r2aVsJaGaZsoV96hbd4sncZlUMvh0M03dEzNkaHdHOEN3HOWcnmuUomtkmb2aYsUOhZeE9LvGj7FKFthGGdbMsCyfbW+cxhHSyz9qBTzPHpE0Mc/Zlhua8ZeD9xsA5xT6QYeZOya7Vug7lDB71bFO3EvbzJjXzdww8DzlELEomMCzYz968gkE9g6VsPuvM7ThtZp+8iWHWLpPySY/ZRV4x829TMQH6nxUYyC0rmfRzWRqW4tMMcvPcfQ1uMe8YuL4wsOQEZQK9wDFtC0vbKgatLObs6ayzcAQYMKiAKYF74obTkmofWAT2q1iqNc8DOoR95nYWoM2uNcwZU1mxBNikTWwQNHkT+4QN1llt2RFlXg3LWbvXsXasZu1Zx1KziDltEkv5fJDOiRuB6uGIgXnOXqbZexhnAdFu5pm7GeYeYpy9n2nSdpbJSGjqDpZpO1lm7WWZuw+CgLqAJAO/b6pIYKZ4aI5keC6/XxqfZyKfdxKPTzI68k7m9U7m8UriBSNBoEqfFAYZYWVtJQNDdVMrQ3tpISUBdgkhTikhDlTEKSXILgmU1ZDXV5PTVZPV0VTQkxJSAgArNJAWzIAInwAAAABJRU5ErkJggg==","aspectRatio":1.1714285714285715,"src":"/static/84f5c2e11f1182ca17a0ba1c0a240c12/1a58a/k4rpYSa.png","srcSet":"/static/84f5c2e11f1182ca17a0ba1c0a240c12/c4d82/k4rpYSa.png 205w,\n/static/84f5c2e11f1182ca17a0ba1c0a240c12/1a58a/k4rpYSa.png 243w","sizes":"(max-width: 243px) 100vw, 243px"}}},"frontmatter":{"title":"Các lỗi dễ mắc khiến việc sử dụng PureComponent, memo thành công cốc","featuredImgAlt":"Các lỗi dễ mắc khiến việc sử dụng PureComponent, memo thành công cốc","featuredImgUrl":"https://i.imgur.com/k4rpYSa.png","description":"Các lỗi sai sau đây sẽ khiến việc sử dụng PureComponent và memo trở thành công cốc. Cùng xem bạn có mắc lỗi nào không nhé!","author":{"name":"Thiên Bùi"},"date":"2020-08-19"}}},"pageContext":{"slug":"/miskates-make-memo-and-pure-component-useless/","previous":{"fields":{"slug":"/things-i-wish-i-knew-as-a-fresher-2/"},"frontmatter":{"title":"Những điều mình ước mình biết được khi mới bắt đầu học lập trình (Phần 2)"}},"next":{"fields":{"slug":"/things-i-wish-i-knew-as-a-fresher/"},"frontmatter":{"title":"Những điều mình ước mình biết được khi mới bắt đầu học lập trình (Phần 1)"}}}}