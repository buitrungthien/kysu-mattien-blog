{"data":{"markdownRemark":{"html":"<p>Có thể bạn đã làm nhiều và có kinh nghiệm với Promise, đã biết cơ chế <a href=\"https://kysumattien.com/javascrip-promise-reject-vs-throw/\" target=\"_blank\" rel=\"noopener noreferrer\">throw, reject Promise</a> hay chỉ mới học và tìm hiểu Promise. Nhiều khi chúng ta sử dụng Promise theo cách được mọi người khuyên như là best practice. Ví dụ như <strong>đặt catch block ở cuối mỗi Promise chain!</strong>, làm thế này, làm thế kia,... chúng ta làm theo, code chạy nhưng cũng chưa hiểu tại sao.</p>\n<p>Hôm nay, trong một ngày đẹp trời, nổi máu <strong>em yêu khoa học</strong>, mình sẽ cùng các bạn cùng nhau đặt ra các câu hỏi \"ngu\" và tìm lời giải đáp về Promise trong JS nhé!</p>\n<h2>1. Best practice bảo hãy đặt .catch block ở cuối mỗi promise - OK, nhưng tại sao?</h2>\n<p>Khi làm việc với Promise, ví dụ như fetch data, chúng ta luôn đặt <strong>.catch</strong> block ở cuối mỗi Promise chain để xử lý lỗi, bằng không JS engine sẽ la lên lỗi <strong>UnhandledPromiseRejectionWarning</strong> (xem lại <a href=\"https://kysumattien.com/javascrip-promise-reject-vs-throw/\" target=\"_blank\" rel=\"noopener noreferrer\">bài trước</a> của mình).</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-api.com'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Bằng cách đặt .catch block ở cuối mỗi Promise chain, bất kỳ lỗi nào xảy ra ở <strong>then</strong> block nào cũng sẽ được bắt và xử lý.</p>\n<p><span class=\"problem-label\">Nhưng <strong>tại sao</strong> lại như vậy?</span></p>\n<p>Để trả lời câu hỏi trên, đầu tiên mình xin được nhắc lại đặc tính cơ bản của Promise, đó là:</p>\n<p>Thứ nhất, <strong>sau mỗi lần thực thi .then() là một Promise mới lại tiếp tục được sinh ra và truyền tiếp cho chuỗi Promise đằng sau</strong>. Đó là lý do chúng ta có thể .then liên tùng tục như thế kia.</p>\n<p>Thứ hai, <strong>.catch</strong> block chính là cách <strong>viết gọn</strong> của <strong>.then(null, rejectHandler)</strong>. Tức là đoạn code trên hoàn toàn có thể được viết lại thành:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user-api.com'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Như ta đã biết, mỗi .then block luôn expect nhận vào 2 tham số: một là fulfillmentHandler - thực thi khi Promise chạy \"thành công\", một là rejectionHanlder - thực thi khi Promise chạy \"thất bại\".</p>\n<p>Như vậy ở dòng code số (2), <code class=\"language-text\">.then(res =&gt; console.log(res))</code> cũng đang chỉ truyền vào fulfillmentHandler và bỏ qua tham số thứ hai là rejectionHandler, hay nói cách khác, nó có thể được viết lại thành <code class=\"language-text\">.then((res) =&gt; {console.log(res)}, null)</code>. .... Lúc này thì nhìn giống giống với anh bạn <code class=\"language-text\">.then(null, (err) =&gt; {console.log(err)})</code> ở dòng số (8) rồi đúng không nào !? Một anh thì bỏ đi <code class=\"language-text\">rejectionHandler</code>, một anh thì bỏ đi <code class=\"language-text\">fulfillmentHanlder</code>.</p>\n<p>Cuối cùng, ý chính thứ ba: trong một <strong>JS Promise chain</strong>, khi một <code class=\"language-text\">.then()</code> block không truyền <strong>rejectionHandler</strong>, thì mặc định các <strong>lỗi</strong> trong Promise chain đó sẽ được <strong>propagate</strong> - lan truyền đến các Promise phía sau trong chuỗi Promise. (Việc lan truyền này cũng xả ra tương tự cho việc không truyền <strong>fulfillmentHanldler</strong>)</p>\n<p>Nhờ tính chất này, mặc dù các .then block đầu ở ví dụ trên không có rejectionHanlder nhưng lỗi vẫn được \"lan truyền\" xuống .catch block cuối cùng để xử lý. Từ đó sinh ra best practice như đã nêu.</p>\n<h2>2. Tại sao không thể bắt lỗi của chính promise trong .then block?</h2>\n<blockquote>\n<p>Như có nhắc đến ở trên thì trong mỗi <code class=\"language-text\">.then</code> block đều có cho mình một <code class=\"language-text\">rejectionHanlder</code>, tại sao bản thân mỗi Promise không tự xử lý lỗi của nó mà phải dựa vào một <code class=\"language-text\">.catch</code> block đặt ở cuối Promise chain?</p>\n</blockquote>\n<p>Tức là:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// khởi tạo foo là object rỗng</span>\n<span class=\"token keyword\">const</span> foo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// step 1:</span>\n<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://some.url.1/'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// step 2:</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    foo<span class=\"token punctuation\">.</span><span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// foo.bar hem có, undifined,</span>\n    <span class=\"token comment\">// lỗi foo.bar is not a function.</span>\n\n    <span class=\"token comment\">// gặp lỗi phía trên ngay lập tức chạy tới đoạn</span>\n    <span class=\"token comment\">// catch để handle lỗi, nên dòng này không chạy</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://some.url.2/?v='</span> <span class=\"token operator\">+</span> response1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// step 3:</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">fulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// never gets here</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// rejection handler to catch the error</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// `TypeError` from `foo.bar()` error</span>\n      <span class=\"token keyword\">return</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// step 4:</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">msg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 42</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Cách viết như ví dụ trên hoàn toàn ok. Ở step 3, chúng ta đã khai báo một <code class=\"language-text\">rejectionHanlder</code> để xử lý lỗi. Tuy nhiên cách viết trên cũng có các mặt hạn chế.</p>\n<p>Thứ nhất, nếu các <code class=\"language-text\">.then()</code> block phía sau ở trong chuỗi Promise chain mà có lỗi, và trong các .then block đó không có rejectionHandler thì mỗi lần nữa JS engine sẽ lại la lên lỗi <strong>UnhandledPromiseRejectionWarning</strong>. Nên cách an toàn nhất vẫn cần đặt thêm một catch block ở cuối mỗi <strong>chain</strong>.</p>\n<p>Thứ hai, ở step 3, tuy đã khai báo rejectionHandler:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// step 3:</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">fulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> num <span class=\"token operator\">=</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">//42 là number, không phải string,</span>\n      <span class=\"token comment\">//nó không có hàm toLowerCase, nên chỗ này sẽ gây ra lỗi</span>\n      num<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// rejection handler to catch the error</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//rejectionHandler này không bắt được lỗi phía trên,</span>\n      <span class=\"token comment\">//hay nói chính xác nó không được chạy, đau lòng!</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Nhưng có một sự thật \"đau lòng\" là hàm <code class=\"language-text\">rejected</code> kia không thể nào bắt được <strong>lỗi xảy ra ở fulfillmentHandler ngay trong Promise đó</strong>.</p>\n<p>Vì sao vậy? Sao Promise <strong>không thông minh</strong> quá vậy?</p>\n<p>Thật ra việc làm này là <strong>có chủ đích</strong>, nó bảo toàn tính chất <strong>immutable</strong> của Promise.</p>\n<p>Promise mang trong mình tính chất immutable - nói rằng khi một promise đã được chạy xong, dù cho là <strong>fulfilled</strong> (thành công) hay <strong>rejected</strong> (thất bại), thì trạng thái <strong>fulfilled</strong> hay <strong>rejected</strong> đó sẽ được duy trì, không thể thay đổi (immutable). Nhờ tính chất này, dù cho có nhiều nơi cùng <strong>lắng nghe</strong> hay <strong>sử dụng</strong> một Promise, thì kết quả sẽ luôn đồng bộ, càng không có chuyện một bên thứ ba có thể can thiệp và thay đổi trạng thái của một Promise dẫn đến các hành vi, luồng chạy code sai lệch và nguy hiểm.</p>\n<p>Ứng với ví dụ trên, khi đi vào tới \"step 3\" và vào được hàm <code class=\"language-text\">fulfilled</code> callback thì coi như Promise mà step 3 này nhận vào đã có trạng thái <strong>fulfilled</strong> - đã <strong>thành công</strong>. Chỉ vì việc có lỗi phát sinh trong callback này mà nhảy xuống <code class=\"language-text\">rejected</code> callback để xử lý thì cũng giống như việc <strong>đổi trạng thái của Promise nhận vào từ fulfilled sang rejected</strong>. Như vậy là đã vi phạm tính chất <strong>immutable</strong> nói trên.</p>\n<p>Như vậy, việc <strong>ngó lơ</strong> lỗi và đoạn code handle lỗi không được thực thi là hoàn toàn hợp lý. Quay lại lỗi <code class=\"language-text\">num.toLowerCase();</code> xảy ra khi chạy hàm <code class=\"language-text\">fulfilled</code>. JS engine thấy rằng đã có lỗi xảy ra, nên <strong>Promise trả ra từ .then block ở step 3 này sẽ có trạng thái là rejected và lỗi sẽ được bắt ở .then block phía sau</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token comment\">// step 3:</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">fulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> num <span class=\"token operator\">=</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">//42 là number, không phải string,</span>\n      <span class=\"token comment\">//nó không có hàm toLowerCase, nên chỗ này sẽ gây ra lỗi</span>\n      num<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// rejection handler to catch the error</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//rejectionHandler này không bắt được lỗi phía trên,</span>\n      <span class=\"token comment\">//hay nói chính xác nó không được chạy, đau lòng!</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token number\">42</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">fulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// rejection handler to catch the error</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//Lỗi sẽ được bắt ở đây</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>3. \"Thenable\" là gì? Tại sao nên \"bọc\" một promise bởi Promise.resolve trước khi sử dụng promise đó?</h2>\n<blockquote>\n<p>Bạn nhận được kết quả trả về từ một object của một bên thứ ba, một package nào đó. Họ nói với bạn object của tui là Promise đó, anh xài như Promise bình thường, <code class=\"language-text\">.then()</code> để xử lý khi logic chạy thành công, <code class=\"language-text\">.catch()</code> để xử lý lỗi, bình thường giống như bao Promise khác.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> p <span class=\"token operator\">=</span> <span class=\"token function\">strangePackage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">...</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Để rồi bạn phát hiện ra code .then này không chạy được bất đồng bộ, handle lỗi bắn tứ tung, thậm chí việc <strong>chain</strong> các block .then như với Promise bình thường cũng không được. Có chuyện gì vậy?</p>\n<p>Tìm hiểu ra thì mới biết ông nội <code class=\"language-text\">strangePackage</code> kia là một object, được cấu tạo như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> strangePackage <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">then</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//do something</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Các object hay cấu trúc như trên được gọi là <strong>thenable</strong>, nói nôm na là <strong>có thể chấm then</strong> được, nhưng rõ ràng không phải là Promise, không chạy giống Promise thuần túy.</p>\n<p>Như vậy, trong thế giới Promise rõ ràng luôn tồn tại một nguy cơ tồn tại các \"promise\" <strong>không đáng tin</strong> như trên, vậy đâu là giải pháp an toàn?</p>\n<p><span class=\"solution-label\">Đó chính là sử dụng Promise.resolve()</span></p>\n<p>Đầu tiên, ta cùng điểm qua một số tính chất cơ bản vô cùng hay ho thường ít được chú ý của <code class=\"language-text\">Promise.resolve()</code></p>\n<p><span class='problem-label'>Truyền vào Promise.resolve một giá trị tức thời, một số, một chuỗi chẳng hạn</span></p>\n<p>Nếu bạn pass một giá trị (tạm gọi là <strong>tức thời</strong>), ví dụ như number, string vào Promise.resolve, bạn sẽ nhận được kết quả trả về là một Promise mới với trạng thái <strong>fulfilled</strong> kèm theo giá trị đó. Xét ví dụ dưới đây, việc khởi tạo p1 từ <code class=\"language-text\">new Promise</code> và p2 từ <code class=\"language-text\">Promise.resolve</code> sẽ cho kết quả tương tự nhau.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">var</span> p1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> p2 <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><span class=\"problem-label\">Truyền vào Promise.resolve một Promise</span></p>\n<p>Nếu bạn pass vào Promise.resolve một Promise, thì ngay lập tức bạn sẽ nhận lại được chính Promise đó.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">var</span> p1 <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> p2 <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>p1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\np1 <span class=\"token operator\">===</span> p2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p><span class=\"problem-label\">Truyền vào Promise.resolve một \"thenable\" object - không phải Promise</span></p>\n<p>Và cuối cùng quan trọng nhất, nếu chúng ta truyền vào Promise.resolve một <strong>thenable</strong> object, hay object giả danh một Promise, thì <strong>thenable</strong> object kia sẽ được Promise.resolve <strong>bóc tách</strong>. Tức là Promise.resolve sẽ mò vào object này, mò từng <strong>lớp</strong>, từng <strong>level</strong> của object đó, xem có prop <strong>.then</strong> hay không, nếu có thì trong <strong>.then</strong> đó có mấy callback, có giống Promise bình thường không,... Công việc này lặp đi lặp lại (recursively) cho đến khi không còn .then nào nữa thì thôi.</p>\n<p>Bước cuối cùng Promise.resolve sẽ trả ra một Promise <strong>bình thường</strong> và an toàn để sử dụng từ anh bạn <strong>thenable</strong> kia. Để dễ hiểu, hãy cùng xem xét các đoạn code ví dụ dưới đây.</p>\n<ul>\n<li>Ví dụ 1: Thenable object không sử dụng Promise.resolve</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">var</span> p <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">then</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cb<span class=\"token punctuation\">,</span> errcb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token number\">42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">errcb</span><span class=\"token punctuation\">(</span><span class=\"token string\">'evil laugh'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\np<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">fulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 42</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// oops, shouldn't have run</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// evil laugh</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Cứ tưởng p là object và cái kết: .then một phát, code chạy cả hàm <code class=\"language-text\">fulfilled</code> và <code class=\"language-text\">rejected</code>, toang.</p>\n<ul>\n<li>Ví dụ 2: Dùng Promise.resolve để cho an toàn</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span> p <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n\t<span class=\"token keyword\">function</span> <span class=\"token function\">fulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span> val <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 42</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">function</span> <span class=\"token function\">rejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// never gets here</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Bằng cách này, thay gì gọi trực tiếp <code class=\"language-text\">p.then()</code>, chúng ta pass nó vào Promise.resolve trước, và kết quả là code chạy ngon lành, đúng logic.</p>\n<p>Túm lại: Bằng cách sử dụng Promise.resolve như các cách trên, chúng ta đã đạt được những lợi ích như: luôn đạt được luồng chạy code bất đồng bộ (vì Promise.resolve luôn trả ra một Promise, dù cho có truyền vào số hay chuỗi thuần) và tiếp theo là giải quyết được các vấn đề về các object thenable, an toàn và tin tưởng hơn khi sử dụng. Thật tuyệt vời!</p>\n<h2>5. Kết luận</h2>\n<p>Bài viết ngày hôm nay mình đã cùng các bạn đặt ra các câu hỏi \"ngu\", để từ đó cùng nhau tìm hiểu các câu trả lời, từ đó nâng cao tình yêu và vốn hiểu biết của chúng ta với JavaScript.</p>\n<p>Không biết bạn như thế nào, chứ bản thân mình luôn cảm thấy phấn khích khi tìm hiểu các vấn đề cốt lõi như trên. Đó cũng chính là lý do mình yêu thích công việc lập trình.</p>\n<p>Hy vọng các bạn cũng sẽ giống mình và luôn ủng hộ \"kỹ sư mặt tiền\" nha.</p>\n<p>Hẹn gặp lại các bạn trong các bài viết tới. Mến chào các bạn!</p>\n<h2>6. Nguồn và bài viết hay liên quan</h2>\n<p>Hầu hết nguồn kiến thức và ý tưởng trong bài viết được mình đọc, tìm hiểu và đúc kết gọn lại từ chương \"Promise\" của cuốn sách nổi tiếng \"You Don't Know JS\". Các bạn có thể tìm hiểu thêm và ủng hộ tác giả nhé:</p>\n<p><a href=\"https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/async%20%26%20performance/ch3.md\" rel=\"noopener noreferrer\">You Don't Know JS: Async &#x26; Performance - Chapter 3: Promises</a> - Tác giả: Kyle Simpson</p>","featuredImg":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAYAQACAwAAAAAAAAAAAAAAAAAAAwECBP/aAAwDAQACEAMQAAAB2I0uSNGkrJrdiOTIB//EABsQAQACAgMAAAAAAAAAAAAAAAEAAhASAxET/9oACAEBAAEFAtib1ZuTkGkDueVsFQx//8QAGhEAAgIDAAAAAAAAAAAAAAAAAQMAEQIQUf/aAAgBAwEBPwEKxIuUvu//xAAYEQACAwAAAAAAAAAAAAAAAAAAAhASIv/aAAgBAgEBPwG7G5//xAAZEAACAwEAAAAAAAAAAAAAAAAAEAEhMWH/2gAIAQEABj8C01cKNVQv/8QAHBABAAMAAgMAAAAAAAAAAAAAAQARIRAxQWGB/9oACAEBAAE/IcbgZkItXMa23mEyj8nqkQSnSdWHH//aAAwDAQACAAMAAAAQF+B8/8QAGBEAAgMAAAAAAAAAAAAAAAAAARARITH/2gAIAQMBAT8QsBSTi//EABgRAAMBAQAAAAAAAAAAAAAAAAABERBR/9oACAECAQE/EGlxovJM/8QAHxABAAIBAwUAAAAAAAAAAAAAAQARIRBRYTFBcYGR/9oACAEBAAE/EErBUeA4aj5GzZi2RiN/HEEUPr9g2fGpiIBMI94C5nrRp//Z","aspectRatio":1.0148514851485149,"src":"/static/4479cd1d22f079d061446e43800ea052/8f023/ROIboLS.jpg","srcSet":"/static/4479cd1d22f079d061446e43800ea052/547bc/ROIboLS.jpg 205w,\n/static/4479cd1d22f079d061446e43800ea052/fb51d/ROIboLS.jpg 410w,\n/static/4479cd1d22f079d061446e43800ea052/8f023/ROIboLS.jpg 820w,\n/static/4479cd1d22f079d061446e43800ea052/76e75/ROIboLS.jpg 1230w,\n/static/4479cd1d22f079d061446e43800ea052/ff2e5/ROIboLS.jpg 1640w,\n/static/4479cd1d22f079d061446e43800ea052/ac0bf/ROIboLS.jpg 1676w","sizes":"(max-width: 820px) 100vw, 820px"}}},"frontmatter":{"title":"Tò mò và những thắc mắc về Promise - Promise liệu có đáng tin?","featuredImgAlt":"JavaScript Promise concerns","featuredImgUrl":"https://i.imgur.com/ROIboLS.jpg?1","description":"JavaScript Promise - những câu hỏi tại sao","author":{"name":"Thiên Bùi"},"date":"2020-10-09"}}},"pageContext":{"slug":"/javascrip-promise-interesting-things/","previous":{"fields":{"slug":"/react-custom-hook/"},"frontmatter":{"title":"Re-use logic giữa các component - HOC - Custom hooks - Quát, quai èn quen?"}},"next":{"fields":{"slug":"/javascrip-promise-reject-vs-throw/"},"frontmatter":{"title":"JavaScript Promise - Không thích thì từ chối, không thích nữa thì quăng luôn!"}}}}